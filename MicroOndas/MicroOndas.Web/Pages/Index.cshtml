@page
@using MicroOndas.Domain.Enums
@model IndexModel
@using System.Text.Encodings.Web

@{
    ViewData["Title"] = "Digital Micro-Oven";

    bool isHeating =
        Model.CurrentHeatingStatus.Status == HeatingStatus.InProgress ||
        Model.CurrentHeatingStatus.Status == HeatingStatus.Paused;

    bool showControlButtons =
        isHeating || Model.CurrentHeatingStatus.Status == HeatingStatus.Completed;
}

<div class="text-center">
    <h1 class="display-4">Digital Micro-Oven</h1>
    <p>Set time (1-120s) and power (1-10, default 10).</p>
    <hr />

    @* ===== MENSAGENS ===== *@
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@HtmlEncoder.Default.Encode(Model.ErrorMessage)</div>
    }

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-warning">@HtmlEncoder.Default.Encode(Model.Message)</div>
    }

    @if (!string.IsNullOrEmpty(Model.TimeConversionMessage))
    {
        <div class="alert alert-info">@HtmlEncoder.Default.Encode(Model.TimeConversionMessage)</div>
    }

    @if (!string.IsNullOrEmpty(Model.InstructionsMessage))
    {
        <div class="alert alert-success mt-3">
            <strong>Instruções:</strong>
            @HtmlEncoder.Default.Encode(Model.InstructionsMessage)
        </div>
    }

    @* ===== DISPLAY PRINCIPAL ===== *@
    <div id="status-display" class="border p-4 mb-4 bg-dark text-light">
        @{
            string statusText = Model.CurrentHeatingStatus.Status.ToString();
            string timerDisplay =
            Model.CurrentHeatingStatus.Status == HeatingStatus.Stopped
            ? "Ready to program"
            : Model.CurrentHeatingStatus.DisplayTimeFormatted;

            string powerText = $"Power: {Model.CurrentHeatingStatus.Power}";
        }

        <div id="status-text" style="font-size: 1.5rem;">@statusText</div>
        <div id="timer-label" style="font-size: 3rem;">
            @timerDisplay | @powerText
        </div>

        @* LIMITADOR DE TAMANHO (evita crescimento infinito da tela) *@
        <div id="process-string"
             style="
                font-size: 1.8rem;
                color: yellow;
                max-height: 120px;
                overflow-y: auto;
                white-space: pre-wrap;
                word-break: break-all;">
            @Model.CurrentHeatingStatus.ProcessingString
        </div>
    </div>

    @* =====================================================
       FORMULÁRIO MANUAL (NÍVEL 1)
       ===================================================== *@
    <form method="post">
        <div class="row justify-content-center mb-4">
            <div class="col-md-3">
                <label>Time (s)</label>
                <input asp-for="InputTime" type="number" class="form-control"
                       min="1" max="120"
                       disabled="@(isHeating || !string.IsNullOrEmpty(Model.SelectedProgramName))" />
            </div>

            <div class="col-md-3">
                <label>Power (1–10)</label>
                <input asp-for="InputPower" type="number" class="form-control"
                       min="1" max="10"
                       disabled="@(isHeating || !string.IsNullOrEmpty(Model.SelectedProgramName))" />
            </div>
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-8">
                <button type="submit" asp-page-handler="StartHeating"
                        class="btn btn-primary mr-2"
                        disabled="@(isHeating && Model.CurrentHeatingStatus.Status != HeatingStatus.Paused)">
                    ▶ Start Heating
                </button>

                <button type="submit" asp-page-handler="QuickStart"
                        class="btn btn-success mr-2"
                        disabled="@(isHeating)">
                    ⏩ Quick Start (+30s)
                </button>

                <button type="submit" asp-page-handler="StartHeating"
                        class="btn btn-warning"
                        disabled="@(Model.CurrentHeatingStatus.Status != HeatingStatus.InProgress
                                                           || Model.CurrentHeatingStatus.IsPredefinedProgram)">
                    ➕ +30s
                </button>
            </div>
        </div>

        <hr />

        @* =====================================================
           PROGRAMAS PRÉ-DEFINIDOS (NÍVEL 2)
           ===================================================== *@
        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <label>Programas Pré-Definidos</label>
                <select asp-for="SelectedProgramName"
                        class="form-control"
                        disabled="@(isHeating)">
                    <option value="">-- Selecione um Programa --</option>
                    @foreach (var program in Model.PredefinedPrograms)
                    {
                        <option value="@program.Name">
                            @program.Name (@program.Food) – P@program.Power – @(program.TimeInSeconds / 60)m
                        </option>
                    }
                </select>
            </div>
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-6">
                <button type="submit"
                        asp-page-handler="StartPredefinedHeating"
                        class="btn btn-info"
                        disabled="@(isHeating)">
                    ⚡ Iniciar Programa Selecionado
                </button>
            </div>
        </div>
    </form>

    <hr />

    @* =====================================================
       CONTROLES (M, N e NÍVEL 2)
       ===================================================== *@
    @if (showControlButtons)
    {
        <form method="post">
            <div class="row justify-content-center">

                @if (Model.CurrentHeatingStatus.Status == HeatingStatus.InProgress)
                {
                    <button asp-page-handler="Pause" class="btn btn-secondary mr-2">
                        ⏸ Pause
                    </button>
                }
                else if (Model.CurrentHeatingStatus.Status == HeatingStatus.Paused)
                {
                    <button asp-page-handler="Continue" class="btn btn-success mr-2">
                        🔁 Continue
                    </button>
                }

                @if (Model.CurrentHeatingStatus.Status is HeatingStatus.InProgress or HeatingStatus.Paused)
                {
                    <button asp-page-handler="Cancel" class="btn btn-danger mr-2">
                        ❌ Cancel
                    </button>
                }

                @if (Model.CurrentHeatingStatus.Status is HeatingStatus.Completed or HeatingStatus.Stopped)
                {
                    <button asp-page-handler="Clear" class="btn btn-secondary">
                        🧹 Clear
                    </button>
                }
            </div>
        </form>
    }

    @section Scripts {
        <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
        <script>
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/microondasHub")
                .build();

            const statusText = document.getElementById("status-text");
            const timerLabel = document.getElementById("timer-label");
            const processString = document.getElementById("process-string");

            connection.on("ReceiveStatus", data => {
                statusText.innerText = data.status;
                timerLabel.innerHTML = `${data.displayTimeFormatted} | Power: ${data.power}`;
                processString.innerText = data.processingString ?? "";

                if (data.status === "Completed") {
                    setTimeout(() => location.reload(), 500);
                }
            });

            connection.start()
                .then(() => console.log("SignalR connected"))
                .catch(err => console.error(err));
        </script>
    }
</div>
